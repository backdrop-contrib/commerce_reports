<?php

/**
 * Implements hook_help().
 */
function commerce_reports_tax_help($path, $arg) {
  switch ($path) {
    case 'admin/commerce/reports/tax':
      return '<p>' . t('The results of tax reports are saved to the database and can be retrieved for later viewing. Here you can create, manage and generate tax reports.') . '</p>';
      
    case 'admin/commerce/reports/tax/%':
      return '<p>' . t('This is a cached overview of your tax report, the results below are not an up-to-date representation of the tax collected by your store. It is rather a snapshot of the situation when the report was last generated. You can regenerate this report or change its parameters on the previous page.') . '</p>';
      
    case 'admin/commerce/reports/tax/%/%':
      return '<p>' . t('The entries below show detailed information about your tax report. Each entry represents the amount of collected tax per order grouped by tax type. It is a snapshot of the situation when the report was last generated. You can regenerate this report or change its parameters on the overview page.') . '</p>';
      
  }
}

/**
 * Implements hook_menu_alter().
 */
function commerce_reports_tax_menu_alter(&$items) {
  $items['admin/commerce/reports/tax']['title'] = 'Tax';
  $items['admin/commerce/reports/tax']['type'] = MENU_LOCAL_TASK;
  $items['admin/commerce/reports/tax']['weight'] = 50;
  
  if (empty($items['admin/commerce/reports'])) {
    $items['admin/commerce/reports'] = array(
      'title' => 'Reports',
      'description' => 'View reports for your store.',
      'access arguments' => array('access commerce tax reports'),
      'page callback' => 'drupal_goto',
      'page arguments' => array('admin/commerce/reports/tax'),
      'weight' => 50,
    );
  }
}

/**
 * Implements hook_views_api().
 */
function commerce_reports_tax_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'commerce_reports_tax') . '/includes/views',
  );
}

/**
 * Implements hook_entity_info().
 */
function commerce_reports_tax_entity_info() {
  return array(
    'commerce_reports_tax' => array(
      'label' => t('tax report'),
      'plural label' => t('Tax reports'),
      'controller class' => 'CommerceReportsTaxEntityController',
      'base table' => 'commerce_reports_tax',
      'uri callback' => 'commerce_reports_tax_uri',
      'entity keys' => array(
        'id' => 'report_id',
        'label' => 'title',
      ),
      'access callback' => 'commerce_reports_tax_access',
      'module' => 'commerce_reports_tax',
      'admin ui' => array(
        'path' => 'admin/commerce/reports/tax',
        'file' => 'commerce_reports_tax.admin.inc',
        'controller class' => 'CommerceReportsTaxUIController',
      ),
    ),
  );
}

/**
 * Implements hook_permission().
 */
function commerce_reports_tax_permission() {
  return array(
    'access commerce tax reports' => array(
      'title' => t('Access commerce tax reports'),
    ),
    'manage commerce tax reports' => array(
      'title' => t('Manage commerce tax reports'),
    ),
  );
}

/**
 * Callback for Entity API access.
 */
function commerce_reports_tax_access($op, $type = NULL, $account = NULL) {
  if ($op = "view") {
    return user_access('access commerce tax reports', $account);
  }
  else {
    return user_access('manage commerce tax reports', $account);
  }
}

function commerce_reports_tax_uri($report) {
  return array(
    'path' => 'admin/commerce/reports/tax/' . $report->report_id,
  );
}

function commerce_reports_tax_new($title = '', $start = NULL, $end = REQUEST_TIME, $order_statuses = array('completed', 'pending'), $detailled = FALSE) {
  if (!isset($end)) {
    $end = REQUEST_TIME;
  }
  
  return entity_get_controller('commerce_reports_tax')->create(array(
    'title' => $title,
    'start' => $start,
    'end' => $end,
    'order_statuses' => $order_statuses,
    'detailed' => $detailled,
  ));
}

function commerce_reports_tax_save($report) {
  return entity_get_controller('commerce_reports_tax')->save($report);
}

function commerce_reports_tax_load($report_id) {
  $reports = commerce_reports_tax_load_multiple(array($report_id), array());
  return $reports ? reset($reports) : FALSE;
}

function commerce_reports_tax_load_multiple($report_ids = array(), $conditions = array(), $reset = FALSE) {
  return entity_load('commerce_reports_tax', $report_ids, $conditions, $reset);
}

function commerce_reports_tax_delete($report_id) {
  return commerce_reports_tax_delete_multiple(array($report_id));
}

function commerce_reports_tax_delete_multiple($report_ids) {
  return entity_get_controller('commerce_reports_tax')->delete($report_ids);
}

function commerce_reports_tax_report_clear($report) {
  commerce_reports_tax_cache_delete(array($report->report_id => $report));
  
  // Update last changed timestamp.
  commerce_reports_tax_save($report);
}

function commerce_reports_tax_generate($report) {
  $batch = array(
    'title' => t('Generating tax report'),
    'operations' => array(
      array('_commerce_reports_tax_create', array($report)),
      array('_commerce_reports_tax_generate', array()),
    ),
    'finished' => '_commerce_reports_tax_finished',
    'file' => drupal_get_path('module', 'commerce_reports_tax') . '/commerce_reports_tax.batch.inc',
  );
  
  batch_set($batch);
}

function commerce_reports_tax_cache_delete($ids) {
  db_delete('commerce_reports_tax_rate_aggregate')
    ->condition('report_id', array_keys($ids), 'IN')
    ->execute();
    
  db_delete('commerce_reports_tax_rate_orders')
    ->condition('report_id', array_keys($ids), 'IN')
    ->execute();
    
  db_delete('commerce_reports_tax_rate')
    ->condition('report_id', array_keys($ids), 'IN')
    ->execute();
}
