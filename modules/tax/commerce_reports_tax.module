<?php

/**
 * Implements hook_menu().
 */
function commerce_reports_tax_menu() {
  $items = array();

  $items['admin/commerce/config/taxes/reports'] = array(
    'title' => 'Tax reporting',
    'description' => 'Tax reporting.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('commerce_reports_tax_generate'),
    'access arguments' =>  array('configure store'),
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implements hook_views_api().
 */
function commerce_reports_tax_views_api() {
  return array(
    'api' => 3,
  );
}

/**
 * Tax report generation form.
 */
function commerce_reports_tax_generate() {
  $form = array();

  $form['commerce_reports_tax_help'] = array(
    '#prefix' => '<p>',
    '#markup' => t('Due to the complexity of most taxation systems, the information needed to display a tax report must be built the first time you install this module.'),
    '#suffix' => '</p>',
  );
  
  $form['commerce_reports_tax_experimental'] = array(
    '#prefix' => '<p>',
    '#markup' => t('This module is still experimental and will possibly not work as expected. It could also be that certain features are dissabled.'),
    '#suffix' => '</p>',
  );

  $form['commerce_reports_tax_generate'] = array(
    '#type' => 'submit',
    '#value' => t('Rebuild tax database'),
  );

  return $form;
}

/**
 * Submit handler for generation form.
 */
function commerce_reports_tax_generate_submit($form, &$form_state) {
  $batch = array(
    'title' => t('Generating tax report'),
    'operations' => array(
      array('_commerce_reports_tax_create', array()),
      array('_commerce_reports_tax_generatre', array()),
    ),
    'finished' => '_commerce_reports_tax_finished',
    'file' => 'commerce_reports_tax.batch.inc',
  );
  
  batch_set($batch);
}
